<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>CHEMONE í’ˆëª© ì¡°íšŒ</title>
  <link rel="icon" href="C-favicon.ico" type="image/x-icon" />
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --line: #e5e7eb;
      --brand: #1e40af;
      --muted: #6b7280;
      --badge-bg: #eef2ff;
      --badge-bd: #c7d2fe;
      --badge-fg: #3730a3;
      --danger-bg: #ffe4e6;
      /* ë” ë°ì€ í•‘í¬ */
      --danger-fg: #ef4444;
      /* ë” ì„ ëª…í•œ ë¹¨ê°• */
      --row-base: #fcfcfd;
      /* ëª¨ë“  í–‰ ê¸°ë³¸ ë°°ê²½ */
      --row-hover: #f3f4f6;
      --radius: 10px;
      --pad: 12px;
      --table-font: 0.92rem;
      --btn-h: 42px;
      /* ë²„íŠ¼/ì…ë ¥ ë†’ì´ í†µì¼ */
    }

    @font-face {
      font-family: 'BladeRunner';
      src: url('blade_runner.ttf') format('truetype');
    }

    @font-face {
      font-family: 'NanumSquareNeo';
      src: url(https://hangeul.pstatic.net/hangeul_static/webfont/NanumSquareNeo/NanumSquareNeoTTF-bRg.woff) format("woff");
    }

    body {
      font-family: 'NanumSquareNeo', sans-serif;
      background: var(--bg);
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
      color: #111827;
    }

    h1 {
      text-align: center;
      font-size: clamp(1.4rem, 2.2vw, 2rem);
      cursor: pointer;
      margin: 0 0 1rem;
    }

    .chemone {
      font-family: 'BladeRunner', sans-serif;
      color: var(--brand);
      letter-spacing: 0.5px;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: 0 1px 3px rgba(16, 24, 40, .06);
    }

    /* ìƒë‹¨ ë°” ì •ë ¬ */
    .bar {
      display: flex;
      gap: .8rem;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .multi-search-section {
      flex: 1;
      min-width: 320px;
    }

    .cas-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: .5rem;
    }

    input[type="text"] {
      height: var(--btn-h);
      padding: 0 .8rem;
      font-size: 1rem;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
    }

    input[type="text"]::placeholder {
      color: #9ca3af;
    }

    /* ë²„íŠ¼ ê³µí†µ */
    .btn {
      height: var(--btn-h);
      padding: 0 1rem;
      background-color: #2563eb;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
      font-weight: 600;
      box-shadow: 0 1px 2px rgba(37, 99, 235, .25);
      white-space: nowrap;
    }

    .btn.secondary {
      background: #eef2ff;
      color: #1f2937;
      box-shadow: none;
      border: 1px solid var(--line);
    }

    .btn svg,
    .icon-btn svg {
      width: 18px;
      height: 18px;
      display: block;
    }

    /* + ë²„íŠ¼ */
    .icon-btn {
      width: var(--btn-h);
      height: var(--btn-h);
      background: #eef2ff;
      color: #1f2937;
      border: 1px solid var(--line);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .actions {
      display: grid;
      grid-auto-flow: column;
      gap: .5rem;
      align-items: center;
    }

    /* ì—…ë¡œë“œ ë ˆì´ì–´: ì™¼ìª½ ì •ë ¬ + ìˆ˜ì§ ê°€ìš´ë° */
    .upload-left {
      display: flex;
      align-items: center;
      gap: .6rem;
      justify-content: flex-start;
      flex: 1 1 auto;
      min-width: 420px;
    }

    .download-side {
      display: flex;
      align-items: center;
      gap: .6rem;
      justify-content: flex-end;
      flex: 0 0 auto;
    }

    .notice {
      color: var(--danger-fg);
      font-size: 0.9rem;
      white-space: nowrap;
    }

    /* âœ… íŒŒì¼ ì…ë ¥ ì»¤ìŠ¤í…€ */
    .file-wrap {
      display: flex;
      align-items: center;
      gap: .6rem;
    }

    #excelInput {
      display: none;
    }

    /* ë„¤ì´í‹°ë¸Œ ì…ë ¥ ìˆ¨ê¹€ */
    .file-btn {
      height: var(--btn-h);
      padding: 0 1rem;
      background: #eef2ff;
      color: #1f2937;
      border: 1px solid var(--line);
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .file-btn svg {
      width: 18px;
      height: 18px;
      display: block;
    }

    .file-name {
      max-width: 260px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .help-text {
      font-size: .85rem;
      color: var(--muted);
      white-space: nowrap;
    }

    details {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      margin-bottom: 1rem;
      padding: .15rem .5rem .55rem;
      /* ì™¸ë¶€í–‰ ì—¬ë°± ì‚´ì§ ê°ì†Œ */
      overflow: hidden;
    }

    summary {
      list-style: none;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
      padding: .45rem .3rem .3rem;
      /* ìŠ¬ë¦¼í™” */
    }

    summary::-webkit-details-marker {
      display: none;
    }

    summary.red {
      color: var(--danger-fg);
    }

    .summary-right {
      display: inline-flex;
      gap: .35rem;
      align-items: center;
      margin-left: auto;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-block;
      font-size: .78rem;
      line-height: 1;
      padding: .35rem .55rem;
      border-radius: 999px;
      border: 1px solid var(--badge-bd);
      background: var(--badge-bg);
      color: var(--badge-fg);
      white-space: nowrap;
    }

    /* ìš”ì•½ì¤„ CAS ìˆ«ì í¬ê²Œ + ê°€ë…ì„± í°íŠ¸ */
    .summary-cas {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 1.12rem;
      letter-spacing: .2px;
    }

    /* í…Œì´ë¸” ë˜í¼: ìŠ¤í¬ë¡¤ë°” ì—†ì´ ê¹”ë”(ë‚´ìš©ì€ ë§ì¤„ì„) */
    .table-wrap {
      width: 100%;
      overflow: hidden;
      /* ìŠ¤í¬ë¡¤ë°” ì œê±° */
      border-radius: 8px;
      border: 1px solid var(--line);
      background: #fff;
    }

    table {
      width: 100%;
      /* ê°€ë¡œí­ 100%ë¡œ ë§ì¶¤ */
      border-collapse: collapse;
      table-layout: fixed;
      /* ì…€ ë„ˆë¹„ ê³ ì • â†’ ë§ì¤„ì„ìœ¼ë¡œ ì •ëˆ */
      font-size: var(--table-font);
    }

    /* ê° ì—´ ìƒëŒ€ ë„ˆë¹„ */
    col.cas {
      width: 12%;
    }

    col.group {
      width: 10%;
    }

    col.code {
      width: 12%;
    }

    col.name {
      width: 20%;
    }

    col.issue {
      width: 12%;
    }

    col.ncis {
      width: 8%;
    }

    col.hazard {
      width: 10%;
    }

    col.reagent {
      width: 10%;
    }

    col.toxicimp {
      width: 10%;
    }

    col.restrict {
      width: 12%;
    }

    col.memo {
      width: 10%;
    }

    th,
    td {
      border-bottom: 1px solid var(--line);
      padding: .55rem .6rem;
      vertical-align: middle;
    }

    thead th {
      background-color: #f3f4f6;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    /* ëª¨ë“  ë‚´ë¶€í–‰ ê¸°ë³¸ ë°°ê²½ ì—°í•˜ê²Œ í†µì¼ */
    tbody td {
      background: var(--row-base);
    }

    tbody tr:hover td {
      background: var(--row-hover);
    }

    /* ì…€ ì •ë¦¬ */
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .center {
      text-align: center;
    }

    .nowrap {
      white-space: nowrap;
    }

    .ellipsis {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .danger {
      color: var(--danger-fg);
      background: var(--danger-bg) !important;
      font-weight: 700;
    }

    .not-found {
      background: #fff0f0;
      color: var(--danger-fg);
      border: 1px solid #fca5a5;
      padding: 1rem;
      margin-top: 2rem;
      border-radius: 8px;
    }

    .header-wrap {
      position: relative;
    }

    .erp-date {
      position: absolute;
      top: 0;
      right: 0;
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
      color: #374151;
      font-size: .92rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
    }

    .erp-date strong {
      font-weight: 700;
      letter-spacing: .2px;
    }

    .erp-date svg {
      width: 16px;
      height: 16px;
      color: #6b7280;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="data.js"></script>
</head>

<body>
  <div class="header-wrap">
    <h1 onclick="location.reload()">
      <span class="chemone">CHEMONE</span> í’ˆëª© ì¡°íšŒ
    </h1>

    <div class="erp-date" aria-label="ERP ì—…ë°ì´íŠ¸ ë‚ ì§œ">
      <!-- calendar icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      ERP ì—…ë°ì´íŠ¸: <strong id="erpDateText">2025-11-03</strong>
    </div>
  </div>


  <!-- ìƒë‹¨ ì…ë ¥/ì•¡ì…˜ -->
  <div class="panel bar">
    <div class="multi-search-section">
      <div id="casContainer">
        <div class="cas-row">
          <input type="text" class="casInput" placeholder="CAS No. ì…ë ¥ (ê³µë°±/ì½¤ë§ˆ/ì„¸ë¯¸ì½œë¡ /ì¤„ë°”ê¿ˆìœ¼ë¡œ ë‹¤ì¤‘ê²€ìƒ‰)" />
          <button class="icon-btn" onclick="addCASInput()" aria-label="ì…ë ¥ì¹¸ ì¶”ê°€">
            <!-- plus icon -->
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="btn" onclick="applyMultipleCASSearch()">
        <!-- search icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="7"></circle>
          <path d="M20 20l-3.5-3.5" stroke-linecap="round" />
        </svg>
        ê²€ìƒ‰
      </button>
      <button class="btn secondary" onclick="applyReset()">
        <!-- reset/refresh icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 1 0 3-6.7" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M3 4v4h4" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        ì´ˆê¸°í™”
      </button>
    </div>
  </div>

  <!-- ì—…ë¡œë“œ + ì•ˆë‚´/ë‹¤ìš´ë¡œë“œ -->
  <div class="panel bar" style="margin-top:.8rem;">
    <!-- ì™¼ìª½: ì»¤ìŠ¤í…€ íŒŒì¼ì„ íƒ + íŒŒì¼ëª… + ì•ˆë‚´ í…ìŠ¤íŠ¸(ì˜¤ë¥¸ìª½ ë°°ì¹˜) -->
    <div class="upload-left">
      <div class="file-wrap">
        <label for="excelInput" class="file-btn" id="chooseFileBtn" aria-label="íŒŒì¼ ì„ íƒ">
          <!-- upload icon -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 3v12m0 0l-4-4m4 4l4-4" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M5 21h14" stroke-linecap="round" />
          </svg>
          íŒŒì¼ ì„ íƒ
        </label>
        <span id="fileName" class="file-name">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
        <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" />
      </div>
      <div class="help-text">CAS ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</div>
    </div>
    <!-- ì˜¤ë¥¸ìª½: ì•ˆë‚´ ë¬¸êµ¬ + ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
    <div class="download-side">
      <div class="notice">*ë¹¨ê°„ìƒ‰ ì…€ì€ ìœ í•´/ìœ ë…/ì œí•œ í‚¤ì›Œë“œì— í•´ë‹¹í•©ë‹ˆë‹¤.</div>
      <button class="btn" onclick="downloadExcel()">
        <!-- download icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 3v12m0 0l-4-4m4 4l4-4" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M5 21h14" stroke-linecap="round" />
        </svg>
        ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
      </button>
    </div>
  </div>

  <div id="resultsContainer" style="margin-top:1rem;"></div>

  <script>
    // Enterë¡œ ê²€ìƒ‰
    document.getElementById('casContainer').addEventListener('keydown', e => {
      if (e.key === 'Enter' && e.target.classList.contains('casInput')) {
        e.preventDefault(); applyMultipleCASSearch();
      }
    });

    const resultsContainer = document.getElementById('resultsContainer');
    let filteredData = [];

    // í‚¤ ì°¾ê¸°(ê³µë°± ë¬´ì‹œ)
    const findKey = (obj, targetKey) =>
      Object.keys(obj).find(k => k.replace(/\s/g, '').toLowerCase() === targetKey.replace(/\s/g, '').toLowerCase());

    const addCASInput = () => {
      const div = document.createElement('div');
      div.className = 'cas-row';
      div.innerHTML = `
        <input type="text" class="casInput" placeholder="CAS No. ì…ë ¥" />
        <button class="icon-btn" onclick="this.parentNode.remove()" aria-label="ì…ë ¥ì¹¸ ì‚­ì œ">
          <!-- minus icon -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>`;
      document.getElementById('casContainer').appendChild(div);
    };

    // CAS ì •ê·œí™”
    const CAS_REGEX = /(\d{2,}-\d{2}-\d)\b/;
    function normalizeCAS(s) {
      const txt = String(s || '').toLowerCase().trim();
      const m = txt.match(CAS_REGEX);
      return m ? m[1] : txt;
    }

    // ë‹¤ì¤‘ ê²€ìƒ‰ì–´ ë¶„ë¦¬ + ì •ê·œí™”
    function tokenizeCAS(text) {
      return (text || '')
        .split(/[\s,;]+/)
        .map(s => normalizeCAS(s))
        .map(s => s.trim())
        .filter(Boolean);
    }
    const unique = arr => Array.from(new Set(arr));

    // ìœ„í—˜ ë‹¨ì–´
    const isDangerVal = val =>
      ['ìœ í•´', 'ìœ ë…', 'ê¸ˆì§€', 'ë¶ˆê°€', 'ì œí•œ', '!!', 'ì”ë¥˜'].some(word => String(val ?? '').includes(word));

    function isDangerGroup(items) {
      const fields = [
        'ìœ í•´í™”í•™ë¬¼íŒë§¤ì—…ì‹ ê³ ',
        'ìœ í•´í™”í•™ë¬¼ì‹œì•½íŒë§¤ì—…ì‹ ê³ ',
        'ìœ ë…ë¬¼ìˆ˜ì…ì‹ ê³ ',
        'ì œí•œë¬¼ì§ˆìˆ˜ì…ì‹ ê³ ',
        'í’ˆëª©ê·¸ë£¹',
        'NCIS'
      ];
      return items.some(item =>
        fields.some(f => {
          const k = findKey(item, f);
          return k && isDangerVal(item[k]);
        })
      );
    }

    // ë±ƒì§€ ë¹Œë”
    function buildODateBadgeText(label, values) {
      if (!values || values.length === 0) return '';
      const hasO = values.some(v => /^o$/i.test(String(v).trim()));
      const dateMatches = unique(values.flatMap(v => String(v).match(/\b\d{6,8}\b/g) || []));
      const parts = [];
      if (hasO) parts.push('O');
      if (dateMatches.length > 0) parts.push(dateMatches.join(' / '));
      return parts.length ? `${label} : ${parts.join(', ')}` : '';
    }
    const buildHazardBadgeText = v => buildODateBadgeText('ìœ í•´í™”í•™ë¬¼íŒë§¤ì—…ì‹ ê³ ', v);
    const buildReagentBadgeText = v => buildODateBadgeText('ìœ í•´í™”í•™ë¬¼ì‹œì•½íŒë§¤ì—…ì‹ ê³ ', v);
    const buildToxicImportBadgeText = v =>
      v && v.length ? `ìœ ë…ë¬¼ìˆ˜ì…ì‹ ê³  : ${unique(v.map(x => String(x).trim())).join(' / ')}` : '';

    // ì œí•œë¬¼ì§ˆìˆ˜ì…ì‹ ê³  ì…€ì— Purity ë¶™ì—¬ ë Œë”
    function renderRestrictedWithPurity(item) {
      const kRestricted = findKey(item, 'ì œí•œë¬¼ì§ˆìˆ˜ì…ì‹ ê³ ');
      const kPurity = findKey(item, 'Purity');
      const restricted = kRestricted ? String(item[kRestricted] ?? '').trim() : '';
      const purity = kPurity ? String(item[kPurity] ?? '').trim() : '';
      return `${restricted}${purity ? ` (${purity})` : ''}`.trim();
    }

    // ê²€ìƒ‰ ì‹¤í–‰ (ë°ì´í„° CASë„ ì •ê·œí™”í•´ì„œ ë¹„êµ)
    function applyMultipleCASSearch() {
      const inputs = document.querySelectorAll('.casInput');
      const keywords = Array.from(inputs).flatMap(i => tokenizeCAS(i.value)).filter(Boolean);
      const uniqueKeywords = unique(keywords);

      const matchedSet = new Set();
      filteredData = window.DATA.filter(item => {
        const key = findKey(item, 'CAS No.');
        const raw = key ? item[key]?.toString() : '';
        const valueNorm = normalizeCAS(raw);
        const matched = uniqueKeywords.includes(valueNorm);
        if (matched) matchedSet.add(valueNorm);
        return matched;
      });

      const unmatched = uniqueKeywords.filter(kw => !matchedSet.has(kw));
      renderAccordion(unmatched);
    }

    // ì•„ì½”ë””ì–¸ ë Œë” (ì •ê·œí™”ëœ CASë¡œ ê·¸ë£¹í•‘)
    function renderAccordion(unmatchedCAS = []) {
      resultsContainer.innerHTML = '';
      if (filteredData.length === 0) resultsContainer.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

      const grouped = {};
      filteredData.forEach(item => {
        const casKey = findKey(item, 'CAS No.');
        const raw = casKey ? (item[casKey] || '') : '';
        const casNorm = normalizeCAS(raw) || '[cas ì—†ìŒ]';
        if (!grouped[casNorm]) grouped[casNorm] = [];
        grouped[casNorm].push(item);
      });

      let groups = Object.entries(grouped).map(([casNorm, items]) => ({
        cas: casNorm, items, danger: isDangerGroup(items)
      }));
      groups.sort((a, b) => (a.danger === b.danger ? a.cas.localeCompare(b.cas, 'ko') : a.danger ? -1 : 1));

      // í—¤ë”
      const header = [
        'CAS No.',
        'í’ˆëª©ê·¸ë£¹',
        'í’ˆëª©ì½”ë“œ',
        'í’ˆëª©ëª…',
        'í’ˆëª©ì´ìŠˆ',
        'NCIS',
        'ìœ í•´í™”í•™ë¬¼íŒë§¤ì—…ì‹ ê³ ',
        'ìœ í•´í™”í•™ë¬¼ ì‹œì•½íŒë§¤ì—…ì‹ ê³ ',
        'ìœ ë…ë¬¼ìˆ˜ì…ì‹ ê³ ',
        'ì œí•œë¬¼ì§ˆìˆ˜ì…ì‹ ê³ (Purity)',
        'ë¹„ê³ '
      ];

      groups.forEach(({ cas, items, danger }) => {
        // ìš”ì•½ ë±ƒì§€
        const hazardVals = collectFieldValues(items, 'ìœ í•´í™”í•™ë¬¼íŒë§¤ì—…ì‹ ê³ ');
        const reagentVals = collectFieldValues(items, 'ìœ í•´í™”í•™ë¬¼ì‹œì•½íŒë§¤ì—…ì‹ ê³ ');
        const toxicVals = collectFieldValues(items, 'ìœ ë…ë¬¼ìˆ˜ì…ì‹ ê³ ');

        const hazardBadge = buildHazardBadgeText(hazardVals);
        const reagentBadge = buildReagentBadgeText(reagentVals);
        const toxicBadge = buildToxicImportBadgeText(toxicVals);

        const details = document.createElement('details');
        const summary = document.createElement('summary');
        summary.className = danger ? 'red' : '';
        summary.innerHTML = `
          <span class="nowrap">
            <strong>CAS No.:</strong>
            <span class="summary-cas">${cas}</span>
            <span style="color:var(--muted); font-weight:500;">(${items.length}ê°œ)</span>
          </span>
          <span class="summary-right">
            ${hazardBadge ? `<span class="badge">${hazardBadge}</span>` : ''}
            ${reagentBadge ? `<span class="badge">${reagentBadge}</span>` : ''}
            ${toxicBadge ? `<span class="badge">${toxicBadge}</span>` : ''}
          </span>
        `;
        details.appendChild(summary);

        // í‘œ
        const tableWrap = document.createElement('div');
        tableWrap.className = 'table-wrap';

        const table = document.createElement('table');
        table.innerHTML = `
          <colgroup>
            <col class="cas"><col class="group"><col class="code"><col class="name"><col class="issue">
            <col class="ncis"><col class="hazard"><col class="reagent"><col class="toxicimp"><col class="restrict"><col class="memo">
          </colgroup>
          <thead><tr>${header.map(h => `<th>${h}</th>`).join('')}</tr></thead>
          <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');

        items.forEach(item => {
          const row = document.createElement('tr');
          header.forEach((h, idx) => {
            const td = document.createElement('td');

            // ì—´ ìŠ¤íƒ€ì¼
            // ğŸ”§ ìˆ˜ì •: CAS, í’ˆëª©ì½”ë“œì—ì„œ ellipsis ì œê±° â†’ ì „ì²´ í‘œì‹œ
            if (idx === 0 || idx === 2) td.classList.add('mono', 'center'); // ellipsis ì œê±°
            if ([1, 5, 6, 7, 8, 9, 10].includes(idx)) td.classList.add('center', 'ellipsis');
            if (idx === 3 || idx === 4) td.classList.add('ellipsis'); // í’ˆëª©ëª…/ì´ìŠˆ

            if (/^ì œí•œë¬¼ì§ˆìˆ˜ì…ì‹ ê³ /i.test(h)) {
              const combined = renderRestrictedWithPurity(item);
              td.innerHTML = combined;
              td.title = combined;
              if (isDangerVal(combined)) td.classList.add('danger');
              row.appendChild(td);
              return;
            }

            const k = findKey(item, h);
            const val = k ? (item[k] ?? '') : '';
            td.innerHTML = val;
            td.title = String(val);
            if (isDangerVal(val)) td.classList.add('danger');
            row.appendChild(td);
          });
          tbody.appendChild(row);
        });

        tableWrap.appendChild(table);
        details.appendChild(tableWrap);
        resultsContainer.appendChild(details);
      });

      if (unmatchedCAS.length > 0) {
        const nf = document.createElement('div');
        nf.className = 'not-found';
        nf.innerHTML = '<strong>ê²€ìƒ‰ë˜ì§€ ì•Šì€ CAS No.:</strong><br>' + unmatchedCAS.join(', ');
        resultsContainer.appendChild(nf);
      }
    }

    // ê°’ ìˆ˜ì§‘
    function collectFieldValues(items, fieldName) {
      const vals = items.map(it => {
        const k = findKey(it, fieldName);
        return k ? String(it[k] ?? '').trim() : '';
      }).filter(v => v.length > 0);
      return unique(vals);
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    const downloadExcel = () => {
      if (filteredData.length === 0) return alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      const ws = XLSX.utils.json_to_sheet(filteredData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'ê²€ìƒ‰ê²°ê³¼');
      XLSX.writeFile(wb, 'ê²€ìƒ‰ê²°ê³¼.xlsx');
    };

    // ì´ˆê¸°í™”
    const applyReset = () => {
      document.getElementById('casContainer').innerHTML = `
        <div class="cas-row">
          <input type="text" class="casInput" placeholder="CAS No. ì…ë ¥ (ê³µë°±/ì½¤ë§ˆ/ì„¸ë¯¸ì½œë¡ /ì¤„ë°”ê¿ˆìœ¼ë¡œ ë‹¤ì¤‘ê²€ìƒ‰)" />
          <button class="icon-btn" onclick="addCASInput()" aria-label="ì…ë ¥ì¹¸ ì¶”ê°€">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>`;
      filteredData = [];
      resultsContainer.innerHTML = '';
      // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” + íŒŒì¼ëª… ë¼ë²¨ ë³µêµ¬
      const inp = document.getElementById('excelInput');
      const fn = document.getElementById('fileName');
      if (inp) inp.value = '';
      if (fn) fn.textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
    };

    // ì—…ë¡œë“œ ì²˜ë¦¬
    document.getElementById('excelInput').addEventListener('change', e => {
      const file = e.target.files[0];

      // â–¼ íŒŒì¼ëª… ë¼ë²¨ ì—…ë°ì´íŠ¸
      const fn = document.getElementById('fileName');
      if (fn) fn.textContent = file ? file.name : 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';

      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = evt.target.result;
        const arr = new Uint8Array(data);
        const workbook = XLSX.read(arr, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const values = rows.flat().map(v => v?.toString() ?? '');
        applyCASFilter(values);
      };
      reader.readAsArrayBuffer(file);
    });

    // ì—…ë¡œë“œ ëª©ë¡ í•„í„°ë§
    function applyCASFilter(casListRaw) {
      const tokens = unique(casListRaw.flatMap(v => tokenizeCAS(v)));
      const matchedSet = new Set();
      filteredData = window.DATA.filter(item => {
        const key = findKey(item, 'CAS No.');
        const raw = key ? item[key]?.toString() : '';
        const valueNorm = normalizeCAS(raw);
        const matched = tokens.includes(valueNorm);
        if (matched) matchedSet.add(valueNorm);
        return matched;
      });
      const unmatched = tokens.filter(kw => !matchedSet.has(kw));
      renderAccordion(unmatched);
    }

    // í•„ìš” ì‹œ ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ í™”ë©´ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.
    document.getElementById('erpDateText').textContent = '2025-11-03';

  </script>
</body>

</html>
