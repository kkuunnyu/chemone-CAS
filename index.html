<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>CHEMONE 품목 조회</title>
  <link rel="icon" href="C-favicon.ico" type="image/x-icon" />
  <style>
    @font-face { font-family: 'BladeRunner'; src: url('blade_runner.ttf') format('truetype'); }
    @font-face {
      font-family: 'NanumSquareNeo';
      src: url(https://hangeul.pstatic.net/hangeul_static/webfont/NanumSquareNeo/NanumSquareNeoTTF-bRg.woff) format("woff");
    }
    body { font-family: 'NanumSquareNeo', sans-serif; background-color: #f4f4f9; padding: 2rem; max-width: 1200px; margin: auto; }
    h1 { text-align: center; font-size: 2rem; cursor: pointer; }
    .chemone { font-family: 'BladeRunner', sans-serif; color: #1e40af; }
    .upload-section, .multi-search-section { margin: 1rem 0; }
    .cas-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    input[type="text"], input[type="file"] { padding: 0.5rem; font-size: 1rem; flex: 1; }
    button { padding: 0.5rem 1rem; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; }
    details { background: white; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 1rem; padding: 0.5rem; }
    summary { font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; }
    summary.red { color: red; }
    .summary-right { display: inline-flex; gap: 0.25rem; align-items: center; margin-left: auto; }
    .badge { display: inline-block; font-size: 0.75rem; line-height: 1; padding: 0.35rem 0.5rem; border-radius: 999px; border: 1px solid #c7d2fe; background: #eef2ff; color: #3730a3; white-space: nowrap; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { border: 1px solid #ddd; padding: 0.4rem; font-size: 0.9rem; }
    th { background-color: #eff6ff; text-align: center; } /* ✅ 헤더 가운데 정렬 */
    td { text-align: left; }
    td.danger { color: red; }
    .not-found { background: #fff0f0; color: #b91c1c; border: 1px solid #fca5a5; padding: 1rem; margin-top: 2rem; }
    .notice { color: red; font-size: 0.9rem; white-space: nowrap; }
    .multi-search-section { display: flex; flex-wrap: wrap; align-items: flex-end; gap: 0.5rem; }
    .multi-search-section > * { margin-top: 0.3rem; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="data.js"></script>
</head>
<body>
  <h1 onclick="location.reload()">
    <span class="chemone">CHEMONE</span> 품목 조회
  </h1>

  <div class="upload-section" style="display: flex; justify-content: flex-end; gap: 1rem;">
    <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" />
    <button onclick="downloadExcel()">엑셀 다운로드</button>
  </div>

  <!-- ✅ CAS 입력 -->
  <div class="multi-search-section">
    <div style="flex: 1; min-width: 300px;" id="casContainer">
      <div class="cas-row">
        <input type="text" class="casInput" placeholder="CAS No. 입력 (공백/콤마/세미콜론/줄바꿈으로 다중검색)" />
        <button onclick="addCASInput()">＋</button>
      </div>
    </div>
  </div>

  <!-- ✅ 버튼 + 안내 -->
  <div class="multi-search-section" style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
    <div>
      <button onclick="applyMultipleCASSearch()">검색</button>
      <button onclick="applyReset()">초기화</button>
    </div>
    <div class="notice" style="margin-left: auto;">*빨간색 표시된 품목은 유독물질 표시입니다.</div>
  </div>

  <div id="resultsContainer"></div>

  <script>
    // Enter로 검색
    document.getElementById('casContainer').addEventListener('keydown', e => {
      if (e.key === 'Enter' && e.target.classList.contains('casInput')) {
        e.preventDefault(); applyMultipleCASSearch();
      }
    });

    const resultsContainer = document.getElementById('resultsContainer');
    let filteredData = [];

    // 키 찾기(공백 무시)
    const findKey = (obj, targetKey) =>
      Object.keys(obj).find(k => k.replace(/\s/g, '').toLowerCase() === targetKey.replace(/\s/g, '').toLowerCase());

    const addCASInput = () => {
      const div = document.createElement('div');
      div.className = 'cas-row';
      div.innerHTML = '<input type="text" class="casInput" placeholder="CAS No. 입력" /> <button onclick="this.parentNode.remove()">－</button>';
      document.getElementById('casContainer').appendChild(div);
    };

    // ✅ CAS 정규화: 접두사 제거하고 "123456-78-9" 패턴만 추출
    const CAS_REGEX = /(\d{2,}-\d{2}-\d)\b/;
    function normalizeCAS(s) {
      const txt = String(s || '').toLowerCase().trim();
      const m = txt.match(CAS_REGEX);
      return m ? m[1] : txt; // 매치되면 그 부분, 아니면 소문자 원문
    }

    // 다중 검색어 분리 + 정규화
    function tokenizeCAS(text) {
      return (text || '')
        .split(/[\s,;]+/)
        .map(s => normalizeCAS(s))
        .map(s => s.trim())
        .filter(Boolean);
    }
    const unique = arr => Array.from(new Set(arr));

    // 위험 단어
    const isDangerVal = val =>
      ['유해', '유독', '금지', '불가', '제한', '!!', '잔류'].some(word => String(val ?? '').includes(word));

    function isDangerGroup(items) {
      const fields = [
        '유해화학물판매업신고',
        '유해화학물시약판매업신고',
        '유독물수입신고',
        '제한물질수입신고',
        '품목그룹',
        'NCIS'
      ];
      return items.some(item =>
        fields.some(f => {
          const k = findKey(item, f);
          return k && isDangerVal(item[k]);
        })
      );
    }

    // ✅ 뱃지 빌더
    function buildODateBadgeText(label, values) {
      if (!values || values.length === 0) return '';
      const hasO = values.some(v => /^o$/i.test(String(v).trim()));
      const dateMatches = unique(values.flatMap(v => String(v).match(/\b\d{6,8}\b/g) || []));
      const parts = [];
      if (hasO) parts.push('O');
      if (dateMatches.length > 0) parts.push(dateMatches.join(' / '));
      return parts.length ? `${label} : ${parts.join(', ')}` : '';
    }
    const buildHazardBadgeText = v => buildODateBadgeText('유해화학물판매업신고', v);
    const buildReagentBadgeText = v => buildODateBadgeText('유해화학물시약판매업신고', v);
    const buildToxicImportBadgeText = v =>
      v && v.length ? `유독물수입신고 : ${unique(v.map(x => String(x).trim())).join(' / ')}` : '';

    // 제한물질수입신고 셀에 Purity 붙여 렌더
    function renderRestrictedWithPurity(item) {
      const kRestricted = findKey(item, '제한물질수입신고');
      const kPurity = findKey(item, 'Purity');
      const restricted = kRestricted ? String(item[kRestricted] ?? '').trim() : '';
      const purity = kPurity ? String(item[kPurity] ?? '').trim() : '';
      return `${restricted}${purity ? ` (${purity})` : ''}`.trim();
    }

    // ✅ 검색 실행 (데이터 CAS도 정규화해서 비교)
    function applyMultipleCASSearch() {
      const inputs = document.querySelectorAll('.casInput');
      const keywords = Array.from(inputs).flatMap(i => tokenizeCAS(i.value)).filter(Boolean);
      const uniqueKeywords = unique(keywords); // 이미 정규화 완료

      const matchedSet = new Set();
      filteredData = window.DATA.filter(item => {
        const key = findKey(item, 'CAS No.');
        const raw = key ? item[key]?.toString() : '';
        const valueNorm = normalizeCAS(raw);        // 데이터 쪽도 정규화
        const matched = uniqueKeywords.includes(valueNorm);
        if (matched) matchedSet.add(valueNorm);
        return matched;
      });

      const unmatched = uniqueKeywords.filter(kw => !matchedSet.has(kw));
      renderAccordion(unmatched);
    }

    // ✅ 아코디언 렌더 (정규화된 CAS로 그룹핑)
    function renderAccordion(unmatchedCAS = []) {
      resultsContainer.innerHTML = '';
      if (filteredData.length === 0) resultsContainer.innerHTML = '<p>검색 결과가 없습니다.</p>';

      const grouped = {};
      filteredData.forEach(item => {
        const casKey = findKey(item, 'CAS No.');
        const raw = casKey ? (item[casKey] || '') : '';
        const casNorm = normalizeCAS(raw) || '[cas 없음]';
        if (!grouped[casNorm]) grouped[casNorm] = [];
        grouped[casNorm].push(item);
      });

      let groups = Object.entries(grouped).map(([casNorm, items]) => ({
        cas: casNorm, items, danger: isDangerGroup(items)
      }));
      groups.sort((a, b) => (a.danger === b.danger ? a.cas.localeCompare(b.cas, 'ko') : a.danger ? -1 : 1));

      // 헤더 (요청 순서 & 라벨)
      const header = [
        'CAS No.',
        '품목그룹',
        '품목코드',
        '품목명',
        '품목이슈',
        'NCIS',
        '유해화학물판매업신고',
        '유해화학물 시약판매업신고',
        '유독물수입신고',
        '제한물질수입신고(Purity)',   // 라벨만 변경
        '비고'
      ];

      groups.forEach(({ cas, items, danger }) => {
        // 요약 뱃지
        const hazardVals  = collectFieldValues(items, '유해화학물판매업신고');
        const reagentVals = collectFieldValues(items, '유해화학물시약판매업신고');
        const toxicVals   = collectFieldValues(items, '유독물수입신고');

        const hazardBadge  = buildHazardBadgeText(hazardVals);
        const reagentBadge = buildReagentBadgeText(reagentVals);
        const toxicBadge   = buildToxicImportBadgeText(toxicVals);

        const details = document.createElement('details');
        const summary = document.createElement('summary');
        summary.className = danger ? 'red' : '';
        summary.innerHTML = `
          <span>
            <strong>CAS No.:</strong>
            <span class="${danger ? 'red' : ''}">${cas}</span>
            <span style="color:gray">(${items.length}개)</span>
          </span>
          <span class="summary-right">
            ${hazardBadge  ? `<span class="badge">${hazardBadge}</span>`   : ''}
            ${reagentBadge ? `<span class="badge">${reagentBadge}</span>` : ''}
            ${toxicBadge   ? `<span class="badge">${toxicBadge}</span>`   : ''}
          </span>
        `;
        details.appendChild(summary);

        // 표
        const table = document.createElement('table');
        table.innerHTML = '<thead><tr>' + header.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
        const tbody = document.createElement('tbody');

        items.forEach(item => {
          const row = document.createElement('tr');
          header.forEach(h => {
            const td = document.createElement('td');

            // 제한물질수입신고(Purity): Purity를 괄호로 덧붙여 표기
            if (/^제한물질수입신고/i.test(h)) {
              const combined = renderRestrictedWithPurity(item);
              td.innerHTML = combined;
              if (isDangerVal(combined)) td.classList.add('danger');
              row.appendChild(td);
              return;
            }

            const k = findKey(item, h);
            const val = k ? (item[k] ?? '') : '';
            td.innerHTML = val;
            if (isDangerVal(val)) td.classList.add('danger');
            row.appendChild(td);
          });
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        details.appendChild(table);
        resultsContainer.appendChild(details);
      });

      if (unmatchedCAS.length > 0) {
        const nf = document.createElement('div');
        nf.className = 'not-found';
        nf.innerHTML = '<strong>검색되지 않은 CAS No.:</strong><br>' + unmatchedCAS.join(', ');
        resultsContainer.appendChild(nf);
      }
    }

    // 값 수집
    function collectFieldValues(items, fieldName) {
      const vals = items.map(it => {
        const k = findKey(it, fieldName);
        return k ? String(it[k] ?? '').trim() : '';
      }).filter(v => v.length > 0);
      return unique(vals);
    }

    // 엑셀 다운로드
    const downloadExcel = () => {
      if (filteredData.length === 0) return alert('데이터가 없습니다.');
      const ws = XLSX.utils.json_to_sheet(filteredData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '검색결과');
      XLSX.writeFile(wb, '검색결과.xlsx');
    };

    // 초기화
    const applyReset = () => {
      document.getElementById('casContainer').innerHTML = `
        <div class="cas-row">
          <input type="text" class="casInput" placeholder="CAS No. 입력 (공백/콤마/세미콜론/줄바꿈으로 다중검색)" />
          <button onclick="addCASInput()">＋</button>
        </div>`;
      filteredData = [];
      resultsContainer.innerHTML = '';
      document.getElementById('excelInput').value = '';
    };

    // 업로드 처리 (엑셀/CSV) → 입력값도 정규화됨
    document.getElementById('excelInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = evt.target.result;
        const arr = new Uint8Array(data);
        const workbook = XLSX.read(arr, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const values = rows.flat().map(v => v?.toString() ?? '');
        applyCASFilter(values);
      };
      reader.readAsArrayBuffer(file);
    });

    // 업로드된 목록 필터링 (정규화 비교)
    function applyCASFilter(casListRaw) {
      const tokens = unique(casListRaw.flatMap(v => tokenizeCAS(v)));
      const matchedSet = new Set();
      filteredData = window.DATA.filter(item => {
        const key = findKey(item, 'CAS No.');
        const raw = key ? item[key]?.toString() : '';
        const valueNorm = normalizeCAS(raw);
        const matched = tokens.includes(valueNorm);
        if (matched) matchedSet.add(valueNorm);
        return matched;
      });
      const unmatched = tokens.filter(kw => !matchedSet.has(kw));
      renderAccordion(unmatched);
    }
  </script>
</body>
</html>
